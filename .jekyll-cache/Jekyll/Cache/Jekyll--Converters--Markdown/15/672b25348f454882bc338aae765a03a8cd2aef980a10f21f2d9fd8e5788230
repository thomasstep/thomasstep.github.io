I"Ä.<p>While building out a small project not too long ago, I ended up wanting to implement my CI/CD using only CodeBuild. I have created pipelines using CodePipeline before that automatically pull the latest changes from a given GitHub repository and act on them. I knew that CodeBuild could be configured to do something similar based on webhooks, but I had never implemented it. The setup is not too difficult, but I did run into one minor problem that I wanted to highlight and explain in this post.</p>

<p>The following paragraphs have some important information about AWS account setup, so please donâ€™t skip to the bottom for the templates.</p>

<p>The CodeBuild instance and template are nothing out of the ordinary. An IAM Role tells CodeBuild what I can do and then the CodeBuild project itself is defined. The one thing that caught me was configuring the <a href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-codebuild-sourcecredential.html">source credentials</a>.</p>

<p>When I originally implemented this, I had the source credentials defined in the same template as my CodeBuild project. Whenever I wanted to spin up another instance (say, for a new environment), I encountered errors on a template that I knew worked. It turns out source credentials need to be unique per provider per AWS account. That means that the <code class="language-plaintext highlighter-rouge">AWS::CodeBuild::SourceCredential</code> resource type should only be used once per <code class="language-plaintext highlighter-rouge">ServerType</code>. Unfortunately, I spent close to an hour searching around and trying to figure this out. The error that held me up looked something like this</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Failed to call ImportSourceCredentials, reason: Access token with server type GITHUB already exists. Delete its source credential and try again.
</code></pre></div></div>

<p>If someone stumbles across this problem in the future, just know, itâ€™s not your fault that AWS has bad error messages.</p>

<p>To wrap this all up, I wanted to first give a template of how to create a source credential, and then I will give the template for the CodeBuild project itself. The templates are also available at my <a href="https://github.com/thomasstep/aws-cloudformation-reference/tree/0d6d79f9db33e8ff3f07c9588a822ddff5ad5109/cicd/codebuild">AWS CloudFormation Reference GitHub repository</a> along with some other helpful templates.</p>

<p>First up is the source credential creation. Remember this only once per account. I currently have the <code class="language-plaintext highlighter-rouge">Parameters</code> set to assume an SSM parameter exists called <code class="language-plaintext highlighter-rouge">codebuild-github-token</code>. This can be changed to whatever name you would like, but I do not recommend copy and pasting a personal access token directly into the CloudFormation parameters.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Parameters</span><span class="pi">:</span>
  <span class="na">GitHubAccessToken</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::SSM::Parameter::Value&lt;String&gt;</span>
    <span class="na">Description</span><span class="pi">:</span> <span class="s">Name of parameter with GitHub access token</span>
    <span class="na">Default</span><span class="pi">:</span> <span class="s">codebuild-github-token</span>
    <span class="na">NoEcho</span><span class="pi">:</span> <span class="s">True</span>

<span class="na">Resources</span><span class="pi">:</span>
  <span class="na">CodeBuildCredentials</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::CodeBuild::SourceCredential</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">ServerType</span><span class="pi">:</span> <span class="s">GITHUB</span>
      <span class="na">AuthType</span><span class="pi">:</span> <span class="s">PERSONAL_ACCESS_TOKEN</span>
      <span class="na">Token</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">GitHubAccessToken</span>
</code></pre></div></div>

<p>After the source credential has been created, we can create our CodeBuild project.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Parameters</span><span class="pi">:</span>
  <span class="na">GitHubUrl</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">String</span>
    <span class="na">Description</span><span class="pi">:</span> <span class="s">URL for GitHub repo i.e. https://github.com/username/repository</span>

<span class="na">Resources</span><span class="pi">:</span>
  <span class="na">CodeBuildRole</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::IAM::Role</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">AssumeRolePolicyDocument</span><span class="pi">:</span>
        <span class="na">Version</span><span class="pi">:</span> <span class="s">2012-10-17</span>
        <span class="na">Statement</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
              <span class="na">Principal</span><span class="pi">:</span>
                  <span class="na">Service</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s">codebuild.amazonaws.com</span>
              <span class="na">Action</span><span class="pi">:</span>
                <span class="pi">-</span> <span class="s">sts:AssumeRole</span>
      <span class="na">Description</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s2">"</span><span class="s">IAM</span><span class="nv"> </span><span class="s">Role</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">${AWS::StackName}"</span>
      <span class="na">Path</span><span class="pi">:</span> <span class="s1">'</span><span class="s">/'</span>
      <span class="na">Policies</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">PolicyName</span><span class="pi">:</span> <span class="s">root</span>
          <span class="na">PolicyDocument</span><span class="pi">:</span>
            <span class="na">Version</span><span class="pi">:</span> <span class="s1">'</span><span class="s">2012-10-17'</span>
            <span class="na">Statement</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">Effect</span><span class="pi">:</span> <span class="s">Allow</span>
                <span class="na">Action</span><span class="pi">:</span>
                  <span class="pi">-</span> <span class="s">cloudformation:*</span>
                  <span class="pi">-</span> <span class="s">codebuild:*</span>
                  <span class="pi">-</span> <span class="s">logs:*</span>
                <span class="na">Resource</span><span class="pi">:</span> <span class="s1">'</span><span class="s">*'</span>
  <span class="na">CodeBuild</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::CodeBuild::Project</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">Description</span><span class="pi">:</span> <span class="s">CodeBuild with GitHub webhook</span>
      <span class="na">Triggers</span><span class="pi">:</span>
        <span class="na">BuildType</span><span class="pi">:</span> <span class="s">BUILD</span>
        <span class="na">Webhook</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">FilterGroups</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="pi">-</span> <span class="na">Type</span><span class="pi">:</span> <span class="s">EVENT</span>
            <span class="na">Pattern</span><span class="pi">:</span> <span class="s">PUSH,PULL_REQUEST_MERGED</span>
          <span class="pi">-</span> <span class="na">Type</span><span class="pi">:</span> <span class="s">HEAD_REF</span>
            <span class="na">Pattern</span><span class="pi">:</span> <span class="s">^refs/heads/main$</span>
            <span class="na">ExcludeMatchedPattern</span><span class="pi">:</span> <span class="no">false</span>
      <span class="na">ServiceRole</span><span class="pi">:</span> <span class="kt">!GetAtt</span> <span class="s">CodeBuildRole.Arn</span>
      <span class="na">Artifacts</span><span class="pi">:</span>
        <span class="na">Type</span><span class="pi">:</span> <span class="s">NO_ARTIFACTS</span>
      <span class="na">Environment</span><span class="pi">:</span>
        <span class="na">Type</span><span class="pi">:</span> <span class="s">LINUX_CONTAINER</span>
        <span class="na">ComputeType</span><span class="pi">:</span> <span class="s">BUILD_GENERAL1_SMALL</span>
        <span class="na">Image</span><span class="pi">:</span> <span class="s">aws/codebuild/standard:4.0</span>
        <span class="na">EnvironmentVariables</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">Name</span><span class="pi">:</span> <span class="s">MY_ENV_VAR</span>
            <span class="na">Value</span><span class="pi">:</span> <span class="s">something</span>
            <span class="na">Type</span><span class="pi">:</span> <span class="s">PLAINTEXT</span>
      <span class="na">Source</span><span class="pi">:</span>
        <span class="na">Type</span><span class="pi">:</span> <span class="s">GITHUB</span>
        <span class="na">Location</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">GitHubUrl</span>
      <span class="na">TimeoutInMinutes</span><span class="pi">:</span> <span class="m">10</span>
  <span class="na">CodeBuildLogGroup</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::Logs::LogGroup</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">LogGroupName</span><span class="pi">:</span> <span class="kt">!Sub</span> <span class="s2">"</span><span class="s">/aws/codebuild/${CodeBuild}"</span>
      <span class="na">RetentionInDays</span><span class="pi">:</span> <span class="m">7</span>

<span class="na">Outputs</span><span class="pi">:</span>
  <span class="na">ProjectName</span><span class="pi">:</span>
    <span class="na">Value</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">CodeBuild</span>
    <span class="na">Description</span><span class="pi">:</span> <span class="s">CodeBuild project name</span>
</code></pre></div></div>

<p>There are few important things to note about this template. First, the IAM Role will need to be tweaked to allow CodeBuild to perform actions specific to your project. Second, the <code class="language-plaintext highlighter-rouge">FilterGroups</code> are currently set up to only trigger on merges and direct pushes to a branch called <code class="language-plaintext highlighter-rouge">main</code>, which might need to change based on your requirements. Lastly, the CodeBuild instance is expected a file called <code class="language-plaintext highlighter-rouge">buildspec.yml</code> to be present in the repoâ€™s root directory. If you do not know what a <code class="language-plaintext highlighter-rouge">buildspec</code> is, please read <a href="https://docs.aws.amazon.com/codebuild/latest/userguide/build-spec-ref.html">this documentation</a> (it is pretty much just a bash script to run when CodeBuild is triggered).</p>
:ET