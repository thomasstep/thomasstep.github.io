I"5:<p>Creating a VPC feels like a rite of passage of sorts to AWS. VPC stands for Virtual Private Cloud, and every AWS account comes with a default VPC already created for us when we get there. VPCs are a way to keep cloud resources isolated. I recently created a <a href="https://github.com/thomasstep/aws-cloudformation-reference/blob/98d23f0b5eef9db731e98b3c38cc8957c60ad8e3/vpc/basic/vpc.yml">CloudFormation template for a basic VPC</a> and I wanted to share a few different pieces that went into building it. Having a basic understanding of networking will probably be beneficial to understand these concepts.</p>

<p>Luckily, I worked as a network engineer for a few summers before I got my software engineering job, so having that background in networking let me bypass having to learn a few concepts while I was building this template. A VPC needs some networking to function correctly. At a minimum, I needed to know what subnets were and how to further subnet my network. The default VPC uses the <code class="language-plaintext highlighter-rouge">172.31.0.0/16</code> network, which is in the <code class="language-plaintext highlighter-rouge">172.16.0.0/12</code> private IP range. I decided to create my VPC using the <code class="language-plaintext highlighter-rouge">10.0.0.0/16</code> network and create 4 <code class="language-plaintext highlighter-rouge">/24</code> subnets inside of it. This is not the most efficient subnetting, but my goal was just to make a baseline template that I could later alter to fit my needs. I wanted 2 public subnets and 2 private subnets in my VPC, which might mean something different to non-AWS users. In AWS, a public subnet is a subnet with a route to an internet gateway, and a private subnet does not have a direct route to an internet gateway. An internet gateway lets traffic flow between the internet and my VPC. I also wanted to add my subnets to 2 different availability zones to increase redundancy in anything that I create.</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">Resources</span><span class="pi">:</span>
  <span class="na">BasicVpc</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::VPC</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">CidrBlock</span><span class="pi">:</span> <span class="s">10.0.0.0/16</span>
      <span class="na">EnableDnsSupport</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>
      <span class="na">EnableDnsHostnames</span><span class="pi">:</span> <span class="s1">'</span><span class="s">true'</span>

  <span class="na">PublicSubnetA</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Subnet</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">CidrBlock</span><span class="pi">:</span> <span class="s">10.0.0.0/24</span>
      <span class="na">AvailabilityZone</span><span class="pi">:</span> <span class="s">us-east-1a</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>
      <span class="na">MapPublicIpOnLaunch</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">PublicSubnetB</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Subnet</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">CidrBlock</span><span class="pi">:</span> <span class="s">10.0.1.0/24</span>
      <span class="na">AvailabilityZone</span><span class="pi">:</span> <span class="s">us-east-1b</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>
      <span class="na">MapPublicIpOnLaunch</span><span class="pi">:</span> <span class="no">true</span>
  <span class="na">PrivateSubnetA</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Subnet</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">CidrBlock</span><span class="pi">:</span> <span class="s">10.0.2.0/24</span>
      <span class="na">AvailabilityZone</span><span class="pi">:</span> <span class="s">us-east-1a</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>
  <span class="na">PrivateSubnetB</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Subnet</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">CidrBlock</span><span class="pi">:</span> <span class="s">10.0.3.0/24</span>
      <span class="na">AvailabilityZone</span><span class="pi">:</span> <span class="s">us-east-1b</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>
</code></pre></div></div>

<p>To allow the instances in my VPC to communicate with the outside world, I needed to give them a route in a route table. That route is for <code class="language-plaintext highlighter-rouge">0.0.0.0/0</code> and is pointed at the internet gateway. I also needed to associate my subnets with the route table that I created.</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">PublicRouteTable</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::RouteTable</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>

  <span class="na">InternetGateway</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::InternetGateway</span>
  <span class="na">InternetGatewayAttachment</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::VPCGatewayAttachment</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">InternetGatewayId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">InternetGateway</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>

  <span class="na">PublicDefaultRoute</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Route</span>
    <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">RouteTableId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PublicRouteTable</span>
        <span class="na">DestinationCidrBlock</span><span class="pi">:</span> <span class="s">0.0.0.0/0</span>
        <span class="na">GatewayId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">InternetGateway</span>

  <span class="na">PublicSubnetARouteTableAssociation</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::SubnetRouteTableAssociation</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">SubnetId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PublicSubnetA</span>
      <span class="na">RouteTableId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PublicRouteTable</span>
  <span class="na">PublicSubnetBRouteTableAssociation</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::SubnetRouteTableAssociation</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">SubnetId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PublicSubnetB</span>
      <span class="na">RouteTableId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PublicRouteTable</span>
</code></pre></div></div>

<p>Next came the private subnets, which had to be configured a little differently. My goal was to be able to spin up compute instances in the private subnets and allow them to communicate with the outside world, which is similar to the public subnets. However, I did not want to give the outside world the option to initiate communication. To set that up I needed to provision a NAT gateway for each availability zone in the corresponding public subnet. Those NAT gateways both needed a public IP or Elastic IP to communicate with the internet and they communicated using through the internet gateway which the public subnets had direct routes to.</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">NatA</span><span class="pi">:</span>
   <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::NatGateway</span>
   <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">AllocationId</span><span class="pi">:</span>
         <span class="s">Fn::GetAtt: EipA.AllocationId</span>
      <span class="na">SubnetId</span><span class="pi">:</span>
         <span class="na">Ref</span><span class="pi">:</span> <span class="s">PublicSubnetA</span>
  <span class="na">EipA</span><span class="pi">:</span>
    <span class="na">DependsOn</span><span class="pi">:</span> <span class="s">InternetGatewayAttachment</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::EIP</span>
    <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">Domain</span><span class="pi">:</span> <span class="s">vpc</span>

  <span class="na">NatB</span><span class="pi">:</span>
   <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::NatGateway</span>
   <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">AllocationId</span><span class="pi">:</span>
         <span class="s">Fn::GetAtt: EipB.AllocationId</span>
      <span class="na">SubnetId</span><span class="pi">:</span>
         <span class="na">Ref</span><span class="pi">:</span> <span class="s">PublicSubnetB</span>
  <span class="na">EipB</span><span class="pi">:</span>
    <span class="na">DependsOn</span><span class="pi">:</span> <span class="s">InternetGatewayAttachment</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::EIP</span>
    <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">Domain</span><span class="pi">:</span> <span class="s">vpc</span>
</code></pre></div></div>

<p>After those NAT gateways were set up, I simply had to create routes from the private subnets to the NAT gateways by telling them that the NAT gateway was the default route, and associate the subnets with the route tables that held those routes.</p>
<div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="na">PrivateRouteTableA</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::RouteTable</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>
  <span class="na">PrivateRouteTableB</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::RouteTable</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">VpcId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">BasicVpc</span>

  <span class="na">NatRouteA</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Route</span>
    <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">RouteTableId</span><span class="pi">:</span>
          <span class="na">Ref</span><span class="pi">:</span> <span class="s">PrivateRouteTableA</span>
        <span class="na">DestinationCidrBlock</span><span class="pi">:</span> <span class="s">0.0.0.0/0</span>
        <span class="na">NatGatewayId</span><span class="pi">:</span>
          <span class="na">Ref</span><span class="pi">:</span> <span class="s">NatA</span>
  <span class="na">NatRouteB</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::Route</span>
    <span class="na">Properties</span><span class="pi">:</span>
        <span class="na">RouteTableId</span><span class="pi">:</span>
          <span class="na">Ref</span><span class="pi">:</span> <span class="s">PrivateRouteTableB</span>
        <span class="na">DestinationCidrBlock</span><span class="pi">:</span> <span class="s">0.0.0.0/0</span>
        <span class="na">NatGatewayId</span><span class="pi">:</span>
          <span class="na">Ref</span><span class="pi">:</span> <span class="s">NatB</span>

  <span class="na">PrivateSubnetARouteTableAssociation</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::SubnetRouteTableAssociation</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">SubnetId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PrivateSubnetA</span>
      <span class="na">RouteTableId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PrivateRouteTableA</span>
  <span class="na">PrivateSubnetBRouteTableAssociation</span><span class="pi">:</span>
    <span class="na">Type</span><span class="pi">:</span> <span class="s">AWS::EC2::SubnetRouteTableAssociation</span>
    <span class="na">Properties</span><span class="pi">:</span>
      <span class="na">SubnetId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PrivateSubnetB</span>
      <span class="na">RouteTableId</span><span class="pi">:</span> <span class="kt">!Ref</span> <span class="s">PrivateRouteTableB</span>
</code></pre></div></div>

<p>The difference between public and private subnets in AWS confused me at first, and I had to go through some trial and error to get this template working. I felt accomplished after getting this done because I had always taken VPC configuration for granted before this. I feel much better versed in VPCs, VPC components, and VPC networking now that I have gone through this exercise.</p>
:ET