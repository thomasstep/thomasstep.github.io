I"¹#<p>I recently wrote some code to dynamically generate a sitemap for one of my blogs that I built using Next.js. For a long time, I was hoping to stumble across someone else who had done something similar that I could copy, but I finally gave in wrote something for myself. I wanted to share what I did in case anyone else wants some inspiration to do something similar.</p>

<p>I wanted my sitemap to be generated as a part of the build process. I use Vercel for my CI/CD and hosting, and they use a default build command of <code class="language-plaintext highlighter-rouge">npm run build</code>. A normal <code class="language-plaintext highlighter-rouge">build</code> script using Next.js is just <code class="language-plaintext highlighter-rouge">next build</code>. My goal was to write a custom script and have it run before Next took over and built my site, so I started by changing my <code class="language-plaintext highlighter-rouge">build</code> script to <code class="language-plaintext highlighter-rouge">node generateStaticPages.js &amp;&amp; next build</code>. My script lives in a file called <code class="language-plaintext highlighter-rouge">generateStaticPages.js</code> in the root directory of my project. Also, the source code is <a href="https://gitlab.com/thomasstep/moneygrowsontrees">available on GitLab</a>. Itâ€™s worth mentioning at this time that my blog is just a collection of markdown files that are converted to HTML at build time and those files all live in a folder called <code class="language-plaintext highlighter-rouge">_posts</code>. The paths for all of those posts are the same as the file names. My goal was to read the file names from the directory, format them with my base URL, add in the extra random pages I have, and write all that to a file.</p>

<p>The starting point for me was to retrieve the list of my postsâ€™ file names. The following function accomplished just that.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">fs</span><span class="dl">'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">path</span><span class="dl">'</span><span class="p">);</span>

<span class="kd">function</span> <span class="nx">getPostSlugs</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">postsDirectory</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="dl">'</span><span class="s1">_posts</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readdirSync</span><span class="p">(</span><span class="nx">postsDirectory</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Pretty straightforward I hope. Simply reading the directory that contains all of my files.</p>

<p>The next few steps were to format those files to their respecting URLs, to add any other pages that I have into the resulting list, and to spit out the text that makes up my sitemap.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">generateSitemapText</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">files</span> <span class="o">=</span> <span class="nx">getPostSlugs</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">postPaths</span> <span class="o">=</span> <span class="nx">files</span><span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="nx">slug</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">`https://moneygrowsontrees.co/blog/</span><span class="p">${</span><span class="nx">slug</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\.</span><span class="sr">md$/</span><span class="p">,</span> <span class="dl">''</span><span class="p">)}</span><span class="s2">`</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">otherPaths</span> <span class="o">=</span> <span class="p">[</span>
    <span class="dl">'</span><span class="s1">https://moneygrowsontrees.co/about</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">https://moneygrowsontrees.co/archive</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">https://moneygrowsontrees.co/tools</span><span class="dl">'</span><span class="p">,</span>
    <span class="dl">'</span><span class="s1">https://moneygrowsontrees.co/tools/compound-interest-calculator</span><span class="dl">'</span><span class="p">,</span>
  <span class="p">];</span>
  <span class="kd">const</span> <span class="nx">allPaths</span> <span class="o">=</span> <span class="nx">otherPaths</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">postPaths</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">sitemapText</span> <span class="o">=</span> <span class="nx">allPaths</span><span class="p">.</span><span class="nx">reduce</span><span class="p">((</span><span class="nx">paths</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">paths</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="dl">'</span><span class="se">\n</span><span class="dl">'</span><span class="p">,</span> <span class="nx">path</span><span class="p">),</span> <span class="dl">'</span><span class="s1">https://moneygrowsontrees.co/</span><span class="dl">'</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">sitemapText</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
<p>The return of <code class="language-plaintext highlighter-rouge">generateSitemapText</code> is the content of my sitemap, so now, I just need to write that information to a file.</p>
<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">async</span> <span class="kd">function</span> <span class="nx">generateSitemap</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">siteMapText</span> <span class="o">=</span> <span class="nx">generateSitemapText</span><span class="p">();</span>

  <span class="kd">const</span> <span class="nx">staticOutputPath</span> <span class="o">=</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">cwd</span><span class="p">(),</span> <span class="dl">'</span><span class="s1">public</span><span class="dl">'</span><span class="p">);</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFile</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">staticOutputPath</span><span class="p">}</span><span class="s2">/sitemap.txt`</span><span class="p">,</span> <span class="nx">siteMapText</span><span class="p">,</span> <span class="nx">err</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">File written successfully</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
<p>My sitemap will now be written to <code class="language-plaintext highlighter-rouge">public/sitemap.txt</code> whenever <code class="language-plaintext highlighter-rouge">generateSitemap()</code> is called, so I finished off the script with a function invocation. If you would like to see the finished product (with some tweaks) <a href="https://gitlab.com/thomasstep/moneygrowsontrees/-/blob/master/generateStaticPages.js">here is a link to that script</a>. I hope this helped!</p>
:ET